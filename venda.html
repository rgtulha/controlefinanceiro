<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Controle Financeiro Interativa com Firebase (Modular SDK)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        h1, h2 {
            color: #1a202c;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #4a5568;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        td {
            background-color: #ffffff;
            font-size: 0.9rem;
        }
        .summary-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .positive {
            color: #10b981; /* Green */
            font-weight: 600;
        }
        .negative {
            color: #ef4444; /* Red */
            font-weight: 600;
        }
        .warning {
            background-color: #fffbeb;
            color: #d97706;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            border: 1px solid #fcd34d;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            font-size: 1rem;
            color: #2d3748;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #4c51bf;
            color: white;
        }
        .btn-primary:hover {
            background-color: #434190;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        .btn-secondary:hover {
            background-color: #cbd5e0;
        }
        .btn-info {
            background-color: #3b82f6; /* Blue */
            color: white;
        }
        .btn-info:hover {
            background-color: #2563eb;
        }
        .installment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .installment-item:last-child {
            border-bottom: none;
        }
        .paid-status {
            color: #10b981;
            font-weight: 500;
        }
        .unpaid-status {
            color: #ef4444;
            font-weight: 500;
        }
        .search-results-table {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .modal-installment-list div {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .modal-installment-list div:last-child {
            border-bottom: none;
        }
        .modal-installment-list .paid {
            color: #a0aec0; /* Gray out paid installments */
            font-style: italic;
            text-decoration: line-through;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="container bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-800">üìä Planilha de Controle Financeiro</h1>
        <p class="text-center text-gray-600 mb-8">Gerencie suas compras, vendas e recebimentos de aparelhos eletr√¥nicos.</p>

        <section class="mb-10">
            <h2 class="text-2xl font-semibold mb-5 text-gray-700">Resumo Financeiro</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="summary-card">
                    <p class="text-sm text-gray-500 mb-1">Capital Inicial</p>
                    <p id="initialCapital" class="text-xl font-bold text-blue-600">R$15.000,00</p>
                </div>
                <div class="summary-card">
                    <p class="text-sm text-gray-500 mb-1">Gasto Total em Compras</p>
                    <p id="totalSpent" class="text-xl font-bold text-gray-800">R$0,00</p>
                </div>
                <div class="summary-card">
                    <p class="text-sm text-gray-500 mb-1">Saldo Atual</p>
                    <p id="currentBalance" class="text-xl font-bold text-gray-800">R$0,00</p>
                    <div id="balanceWarning" class="warning mt-2 hidden">
                        <p>‚ö†Ô∏è Aten√ß√£o: Voc√™ excedeu o capital inicial de R$15.000!</p>
                    </div>
                </div>
                <div class="summary-card">
                    <p class="text-sm text-gray-500 mb-1">Lucro L√≠quido Previsto</p>
                    <p id="netProfit" class="text-xl font-bold text-gray-800">R$0,00</p>
                </div>
            </div>
        </section>

        <section class="mb-10 p-6 bg-blue-50 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-5 text-gray-700">Adicionar Nova Compra</h2>
            <form id="addPurchaseForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="purchaseDate">Data da Compra:</label>
                    <input type="date" id="purchaseDate" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="purchaseDevice">Aparelho:</label>
                    <input type="text" id="purchaseDevice" placeholder="Ex: iPhone 16 Pro" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="purchaseCost">Custo (R$):</label>
                    <input type="number" id="purchaseCost" step="0.01" min="0" placeholder="Ex: 6449.00" class="rounded-md" required>
                </div>
                <div class="md:col-span-3 text-right">
                    <button type="submit" class="btn btn-primary">Adicionar Compra</button>
                </div>
            </form>
        </section>

        <section class="mb-10">
            <h2 class="text-2xl font-semibold mb-5 text-gray-700">Detalhes das Compras (Estoque e Custo)</h2>
            <div class="table-responsive">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Data da Compra</th>
                            <th>Aparelho</th>
                            <th class="rounded-tr-lg">Custo (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="purchasesTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section class="mb-10 p-6 bg-green-50 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-5 text-gray-700">Adicionar Nova Venda</h2>
            <form id="addSaleForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="saleCustomer">Cliente:</label>
                    <input type="text" id="saleCustomer" placeholder="Ex: Junior Pereira Agehab" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="saleDevice">Aparelho:</label>
                    <input type="text" id="saleDevice" placeholder="Ex: Apple Watch SE" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="saleDate">Data da Venda:</label>
                    <input type="date" id="saleDate" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="salePrice">Valor de Venda (R$):</label>
                    <input type="number" id="salePrice" step="0.01" min="0" placeholder="Ex: 2150.00" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="saleCost">Custo (R$):</label>
                    <input type="number" id="saleCost" step="0.01" min="0" placeholder="Ex: 1700.00" class="rounded-md" required>
                </div>
                <div class="form-group">
                    <label for="saleDownPayment">Entrada (R$):</label>
                    <input type="number" id="saleDownPayment" step="0.01" min="0" placeholder="Ex: 450.00" class="rounded-md" required>
                </div>
                <div class="form-group lg:col-span-3">
                    <label for="saleInstallmentsCount">N√∫mero de Parcelas:</label>
                    <input type="number" id="saleInstallmentsCount" min="0" value="0" class="rounded-md">
                </div>
                <div id="installmentAmountsContainer" class="form-group lg:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                    </div>
                <div class="md:col-span-3 text-right">
                    <button type="submit" class="btn btn-primary">Adicionar Venda</button>
                </div>
            </form>
        </section>

        <section class="mb-10">
            <h2 class="text-2xl font-semibold mb-5 text-gray-700">Detalhes das Vendas e Recebimentos</h2>
            <div class="table-responsive">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Cliente</th>
                            <th>Aparelho</th>
                            <th>Data da Venda</th>
                            <th>Valor Total (R$)</th>
                            <th>Entrada (R$)</th>
                            <th>Status Parcelas</th>
                            <th>A Receber (R$)</th>
                            <th class="rounded-tr-lg">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section class="mb-10">
            <h2 class="2xl font-semibold mb-5 text-gray-700">Recebimentos Mensais Previstos</h2>
            <div class="mb-4 flex items-center gap-4">
                <label for="monthSelector" class="font-medium text-gray-700">Selecionar M√™s:</label>
                <select id="monthSelector" class="rounded-md p-2 border border-gray-300"></select>
            </div>
            <div class="table-responsive">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">M√™s / Ano</th>
                            <th class="rounded-tr-lg">Total Mensal (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyReceivablesTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section class="mb-10 p-6 bg-purple-50 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-5 text-gray-700">Pesquisar Vendas por Cliente</h2>
            <div class="form-group flex gap-4 items-end">
                <div class="flex-grow">
                    <label for="searchClientName">Nome do Cliente:</label>
                    <input type="text" id="searchClientName" placeholder="Digite o nome do cliente" class="rounded-md">
                </div>
                <button id="searchSalesBtn" class="btn btn-info whitespace-nowrap">Pesquisar</button>
            </div>
            <div id="searchResults" class="mt-6 hidden search-results-table">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Resultados da Pesquisa</h3>
                <div class="table-responsive">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Aparelho</th>
                                <th>Data Venda</th>
                                <th>Valor Total</th>
                                <th>Entrada</th>
                                <th>Valor a Pagar</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <div id="installmentDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideInstallmentDetailsModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800">Detalhes das Parcelas</h3>
            <p class="mb-4 text-gray-600" id="modalSaleInfo"></p>
            <div id="modalInstallmentList" class="modal-installment-list">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, query, where, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

        // Suas credenciais do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAMH82yDdZ2CnDSiosDUCJv2sXTjjRHemg",
            authDomain: "controlevenda-ef7db.firebaseapp.com",
            projectId: "controlevenda-ef7db",
            storageBucket: "controlevenda-ef7db.firebasestorage.app",
            messagingSenderId: "468868061475",
            appId: "1:468868061475:web:e4848ef26c1f1eeaa61496"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const INITIAL_CAPITAL = 15000;
        let purchases = [];
        let sales = [];

        // Autentica√ß√£o an√¥nima para que o usu√°rio possa interagir com o Firestore
        signInAnonymously(auth).catch((error) => {
            console.error("Erro na autentica√ß√£o an√¥nima:", error);
            alert("N√£o foi poss√≠vel conectar ao banco de dados. Verifique sua conex√£o ou as configura√ß√µes do Firebase.");
        });

        const formatCurrency = (value) => {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const calculateInstallmentDueDate = (saleDateStr, installmentIndex) => {
            const saleDate = new Date(saleDateStr + 'T00:00:00');
            let dueDate = new Date(saleDate.getFullYear(), saleDate.getMonth() + 1 + installmentIndex, 10);
            return dueDate.toISOString().split('T')[0];
        };

        // --- Fun√ß√µes de Intera√ß√£o com Firestore ---

        const addPurchaseToFirestore = async (purchaseData) => {
            try {
                await addDoc(collection(db, 'purchases'), purchaseData);
            } catch (e) {
                console.error("Erro ao adicionar compra: ", e);
                alert("Erro ao salvar a compra. Tente novamente.");
            }
        };

        const addSaleToFirestore = async (saleData) => {
            try {
                await addDoc(collection(db, 'sales'), saleData);
            } catch (e) {
                console.error("Erro ao adicionar venda: ", e);
                alert("Erro ao salvar a venda. Tente novamente.");
            }
        };

        const updateSaleInstallmentStatusInFirestore = async (saleId, updatedInstallments) => {
            try {
                await updateDoc(doc(db, 'sales', saleId), { installments: updatedInstallments });
            } catch (e) {
                console.error("Erro ao atualizar parcela: ", e);
                alert("Erro ao atualizar o status da parcela. Tente novamente.");
            }
        };

        // --- Fun√ß√µes de Renderiza√ß√£o (Agora com base em dados de Firestore) ---

        const renderSummary = () => {
            const totalSpent = purchases.reduce((sum, item) => sum + item.cost, 0);
            
            // C√ÅLCULO ATUALIZADO DO SALDO ATUAL: CAPITAL INICIAL - GASTO TOTAL EM COMPRAS
            const currentBalance = INITIAL_CAPITAL - totalSpent; 
            
            // C√ÅLCULO ATUALIZADO DO LUCRO L√çQUIDO PREVISTO: (VALOR DE VENDA - VALOR DE COMPRA) DE CADA VENDA
            const netProfit = sales.reduce((sum, sale) => sum + (sale.salePrice - sale.cost), 0); 

            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
            document.getElementById('currentBalance').className = currentBalance >= 0 ? 'text-xl font-bold positive' : 'text-xl font-bold negative';

            const balanceWarning = document.getElementById('balanceWarning');
            if (totalSpent > INITIAL_CAPITAL) {
                balanceWarning.classList.remove('hidden');
            } else {
                balanceWarning.classList.add('hidden');
            }

            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            document.getElementById('netProfit').className = netProfit >= 0 ? 'text-xl font-bold positive' : 'text-xl font-bold negative';
        };

        const renderPurchases = () => {
            const tbody = document.getElementById('purchasesTableBody');
            tbody.innerHTML = '';

            purchases.forEach(purchase => {
                const row = tbody.insertRow();
                row.insertCell().textContent = new Date(purchase.date + 'T00:00:00').toLocaleDateString('pt-BR');
                row.insertCell().textContent = purchase.device;
                row.insertCell().textContent = formatCurrency(purchase.cost);
            });
        };

        const renderSales = () => {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';

            sales.forEach((sale) => {
                const row = tbody.insertRow();
                const totalInstallmentsValue = sale.installments.reduce((sum, inst) => sum + inst.amount, 0);
                const paidInstallmentsValue = sale.installments.filter(inst => inst.paid).reduce((sum, inst) => sum + inst.amount, 0);
                const remainingToPay = (sale.salePrice - sale.downPayment) - paidInstallmentsValue;

                const paidCount = sale.installments.filter(inst => inst.paid).length;
                const totalCount = sale.installments.length;

                let installmentStatusText = '';
                if (totalCount === 0) {
                    installmentStatusText = '√Ä Vista (Quitado)';
                } else if (paidCount === totalCount) {
                    installmentStatusText = 'Todas Pagas';
                } else {
                    installmentStatusText = `${paidCount}/${totalCount} Pagas`;
                }

                row.insertCell().textContent = sale.customer;
                row.insertCell().textContent = sale.device;
                row.insertCell().textContent = new Date(sale.saleDate + 'T00:00:00').toLocaleDateString('pt-BR');
                row.insertCell().textContent = formatCurrency(sale.salePrice);
                row.insertCell().textContent = formatCurrency(sale.downPayment);

                // Coluna de Status das Parcelas
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<span class="${paidCount === totalCount ? 'paid-status' : 'unpaid-status'}">${installmentStatusText}</span>`;

                // Coluna de Valor a Receber (R$)
                const remainingCell = row.insertCell();
                remainingCell.textContent = formatCurrency(remainingToPay < 0 ? 0 : remainingToPay); // N√£o mostra negativo
                remainingCell.className = remainingToPay > 0 ? 'negative' : 'positive';

                // Coluna de A√ß√µes: Dropdown para selecionar parcela a pagar
                const actionsCell = row.insertCell();
                if (totalCount > 0 && paidCount < totalCount) { // Se houver parcelas e nem todas pagas
                    const selectElement = document.createElement('select');
                    selectElement.className = 'rounded-md p-1 border border-gray-300 text-sm';
                    selectElement.style.minWidth = '150px'; // Ensure it's wide enough
                    selectElement.innerHTML = '<option value="">Selecionar Parcela</option>'; // Default option

                    sale.installments.forEach((installment, instIndex) => {
                        const option = document.createElement('option');
                        // Use a unique value for each option to identify sale and installment
                        option.value = `${sale.id}_${instIndex}`;
                        // Modificado para remover "Parcela", usar ¬∞ e ano com 2 d√≠gitos
                        const dueDateFormatted = new Date(installment.dueDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
                        option.textContent = `${instIndex + 1}¬∞: ${formatCurrency(installment.amount)} (Venc: ${dueDateFormatted})`;

                        if (installment.paid) {
                            option.disabled = true;
                            option.classList.add('text-gray-400', 'italic'); // Add classes for styling paid installments
                        }
                        selectElement.appendChild(option);
                    });

                    selectElement.onchange = async (event) => {
                        const [selectedSaleId, selectedInstIndex] = event.target.value.split('_');
                        if (selectedSaleId && selectedInstIndex) {
                            await markInstallmentAsPaid(selectedSaleId, parseInt(selectedInstIndex));
                            event.target.value = ''; // Reset dropdown after selection
                        }
                    };
                    actionsCell.appendChild(selectElement);
                } else if (totalCount === 0) {
                    actionsCell.textContent = '√Ä Vista';
                } else {
                    actionsCell.textContent = 'Todas Recebidas';
                }
            });
        };

        const renderMonthlyReceivables = (filterMonthYear = null) => {
            const tbody = document.getElementById('monthlyReceivablesTableBody');
            tbody.innerHTML = '';

            const monthlyData = {};
            const customers = new Set();

            sales.forEach(sale => {
                customers.add(sale.customer);
                sale.installments.forEach((installment) => {
                    if (!installment.paid) {
                        const dueDate = new Date(installment.dueDate + 'T00:00:00');
                        const monthYearKey = `${(dueDate.getMonth() + 1).toString().padStart(2, '0')}/${dueDate.getFullYear()}`;

                        // Filtra pelo m√™s/ano selecionado, se houver
                        if (filterMonthYear && filterMonthYear !== 'all' && monthYearKey !== filterMonthYear) {
                            return; // Pula se n√£o for o m√™s selecionado
                        }

                        if (!monthlyData[monthYearKey]) {
                            monthlyData[monthYearKey] = {};
                        }
                        if (!monthlyData[monthYearKey][sale.customer]) {
                            monthlyData[monthYearKey][sale.customer] = 0;
                        }
                        monthlyData[monthYearKey][sale.customer] += installment.amount;
                    }
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            const monthlyHeaderRow = document.querySelector('#monthlyReceivablesTableBody').previousElementSibling.querySelector('thead tr');
            monthlyHeaderRow.innerHTML = `<th class="rounded-tl-lg">M√™s / Ano</th>`;
            const sortedCustomers = Array.from(customers).sort();
            sortedCustomers.forEach(customer => {
                monthlyHeaderRow.innerHTML += `<th>${customer}</th>`;
            });
            monthlyHeaderRow.innerHTML += `<th class="rounded-tr-lg">Total Mensal (R$)</th>`;


            sortedMonths.forEach(monthYearKey => {
                const row = tbody.insertRow();
                row.insertCell().textContent = monthYearKey;
                let totalMonthly = 0;

                sortedCustomers.forEach(customer => {
                    const amount = monthlyData[monthYearKey][customer] || 0;
                    row.insertCell().textContent = formatCurrency(amount);
                    totalMonthly += amount;
                });

                const totalCell = row.insertCell();
                totalCell.textContent = formatCurrency(totalMonthly);
                totalCell.classList.add('font-bold');
            });
        };

        const renderAll = () => {
            renderSummary();
            renderPurchases();
            // renderSales() √© chamado pelo onSnapshot de sales
            // renderMonthlyReceivables() √© chamado pelo onSnapshot de sales
        };

        // Fun√ß√£o para popular o seletor de meses
        const populateMonthSelector = () => {
            const monthSelector = document.getElementById('monthSelector');
            monthSelector.innerHTML = '<option value="all">Todos os Meses</option>'; // Op√ß√£o para ver todos

            const uniqueMonths = new Set();
            sales.forEach(sale => {
                sale.installments.forEach(inst => {
                    const dueDate = new Date(inst.dueDate + 'T00:00:00');
                    uniqueMonths.add(`${(dueDate.getMonth() + 1).toString().padStart(2, '0')}/${dueDate.getFullYear()}`);
                });
            });

            const sortedMonths = Array.from(uniqueMonths).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            sortedMonths.forEach(monthYear => {
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = monthYear;
                monthSelector.appendChild(option);
            });

            // Define o m√™s corrente como padr√£o
            const today = new Date();
            const currentMonthYear = `${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            if (uniqueMonths.has(currentMonthYear)) {
                monthSelector.value = currentMonthYear;
            } else {
                monthSelector.value = 'all'; // Se o m√™s atual n√£o tiver dados, mostra todos
            }
        };

        // --- Fun√ß√µes para o Modal de Detalhes das Parcelas ---
        const showInstallmentDetailsModal = (sale) => {
            const modal = document.getElementById('installmentDetailsModal');
            const modalInstallmentList = document.getElementById('modalInstallmentList');
            const modalSaleInfo = document.getElementById('modalSaleInfo');

            modalInstallmentList.innerHTML = ''; // Limpa a lista anterior

            modalSaleInfo.textContent = `Venda: ${sale.device} para ${sale.customer} (Valor Total: ${formatCurrency(sale.salePrice)})`;

            if (sale.installments && sale.installments.length > 0) {
                sale.installments.forEach((installment, index) => {
                    const installmentDiv = document.createElement('div');
                    const dueDateFormatted = new Date(installment.dueDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
                    
                    let statusText = installment.paid ? 'Paga' : 'A Receber';
                    let statusClass = installment.paid ? 'paid' : 'unpaid-status';

                    installmentDiv.innerHTML = `
                        <span class="${statusClass}">${index + 1}¬∞: ${formatCurrency(installment.amount)} (Venc: ${dueDateFormatted}) - ${statusText}</span>
                    `;
                    modalInstallmentList.appendChild(installmentDiv);
                });
            } else {
                const noInstallmentsDiv = document.createElement('div');
                noInstallmentsDiv.textContent = 'Esta venda n√£o possui parcelas.';
                modalInstallmentList.appendChild(noInstallmentsDiv);
            }

            modal.classList.add('show'); // Exibe o modal
        };

        // Tornando a fun√ß√£o global para ser acess√≠vel do onclick no HTML
        window.hideInstallmentDetailsModal = () => {
            document.getElementById('installmentDetailsModal').classList.remove('show'); // Esconde o modal
        };

        // --- Fun√ß√µes de Pesquisa ---
        const searchSalesByClient = async (clientName) => {
            const resultsBody = document.getElementById('searchResultsTableBody');
            resultsBody.innerHTML = '';
            document.getElementById('searchResults').classList.add('hidden'); // Oculta resultados antigos

            if (!clientName) {
                alert('Por favor, digite o nome do cliente para pesquisar.');
                return;
            }

            try {
                // Consulta no Firestore (Modular API)
                const q = query(collection(db, 'sales'), where('customer', '==', clientName));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    resultsBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">Nenhuma venda encontrada para "${clientName}".</td></tr>`;
                } else {
                    querySnapshot.forEach(doc => {
                        const sale = doc.data();
                        const saleId = doc.id; // Obter o ID do documento

                        const totalInstallmentsValue = sale.installments.reduce((sum, inst) => sum + inst.amount, 0);
                        const paidInstallmentsValue = sale.installments.filter(inst => inst.paid).reduce((sum, inst) => sum + inst.amount, 0);
                        const remainingToPay = (sale.salePrice - sale.downPayment) - paidInstallmentsValue;
                        const totalSaleValue = sale.salePrice;

                        let status = '';
                        if (remainingToPay <= 0) {
                            status = 'Quitado';
                        } else if (sale.installments.some(inst => !inst.paid)) {
                            status = 'Parcelas Pendentes';
                        } else {
                            status = 'Em Aberto (Verificar)'; // Caso tenha entrada mas sem parcelas ou algo assim
                        }

                        const row = resultsBody.insertRow();
                        row.insertCell().textContent = sale.customer;
                        row.insertCell().textContent = sale.device;
                        row.insertCell().textContent = new Date(sale.saleDate + 'T00:00:00').toLocaleDateString('pt-BR');
                        row.insertCell().textContent = formatCurrency(totalSaleValue);
                        row.insertCell().textContent = formatCurrency(sale.downPayment);
                        const remainingCell = row.insertCell();
                        remainingCell.textContent = formatCurrency(remainingToPay < 0 ? 0 : remainingToPay); // N√£o mostrar negativo
                        remainingCell.className = remainingToPay > 0 ? 'negative' : 'positive';
                        row.insertCell().textContent = status;

                        // A√ß√µes para parcelas da pesquisa
                        const actionsCell = row.insertCell();
                        if (sale.installments && sale.installments.length > 0) {
                            const detailsButton = document.createElement('button');
                            detailsButton.textContent = 'Ver Detalhes';
                            detailsButton.className = 'btn btn-info text-xs py-1 px-2';
                            detailsButton.onclick = () => showInstallmentDetailsModal(sale); // Chama a fun√ß√£o do modal
                            actionsCell.appendChild(detailsButton);
                        } else {
                            actionsCell.textContent = '√Ä Vista';
                        }
                    });
                }
                document.getElementById('searchResults').classList.remove('hidden'); // Mostra a se√ß√£o de resultados
            } catch (error) {
                console.error("Erro ao pesquisar vendas: ", error);
                alert("Ocorreu um erro ao pesquisar as vendas. Verifique o console para mais detalhes.");
            }
        };

        // --- Listeners de Eventos ---

        document.getElementById('addPurchaseForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const date = document.getElementById('purchaseDate').value;
            const device = document.getElementById('purchaseDevice').value;
            const cost = parseFloat(document.getElementById('purchaseCost').value);

            if (date && device && !isNaN(cost)) {
                await addPurchaseToFirestore({ date, device, cost });
                event.target.reset();
            } else {
                alert('Por favor, preencha todos os campos da compra corretamente.');
            }
        });

        document.getElementById('addSaleForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const customer = document.getElementById('saleCustomer').value;
            const device = document.getElementById('saleDevice').value;
            const saleDate = document.getElementById('saleDate').value;
            const salePrice = parseFloat(document.getElementById('salePrice').value);
            const cost = parseFloat(document.getElementById('saleCost').value);
            const downPayment = parseFloat(document.getElementById('saleDownPayment').value);
            const installmentsCount = parseInt(document.getElementById('saleInstallmentsCount').value);

            const newInstallments = [];
            for (let i = 0; i < installmentsCount; i++) {
                const amount = parseFloat(document.getElementById(`installmentAmount${i}`).value);
                if (isNaN(amount) || amount <= 0) {
                    alert(`Por favor, preencha o valor da parcela ${i + 1} corretamente.`);
                    return;
                }
                newInstallments.push({ amount, paid: false, dueDate: calculateInstallmentDueDate(saleDate, i) });
            }

            if (customer && device && saleDate && !isNaN(salePrice) && !isNaN(cost) && !isNaN(downPayment) &&
                (installmentsCount === 0 || newInstallments.length === installmentsCount)) {
                await addSaleToFirestore({
                    customer,
                    device,
                    saleDate,
                    salePrice,
                    cost,
                    downPayment,
                    installments: newInstallments,
                    createdAt: serverTimestamp() // Modular API
                });
                event.target.reset();
                document.getElementById('installmentAmountsContainer').classList.add('hidden');
            } else {
                alert('Por favor, preencha todos os campos da venda corretamente.');
            }
        });

        document.getElementById('saleInstallmentsCount').addEventListener('input', (event) => {
            const count = parseInt(event.target.value);
            const container = document.getElementById('installmentAmountsContainer');
            container.innerHTML = '';

            if (count > 0) {
                container.classList.remove('hidden');
                for (let i = 0; i < count; i++) {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label for="installmentAmount${i}">Valor da Parcela ${i + 1} (R$):</label>
                        <input type="number" id="installmentAmount${i}" step="0.01" min="0" placeholder="Ex: 560.00" class="rounded-md" required>
                    `;
                    container.appendChild(div);
                }
            } else {
                container.classList.add('hidden');
            }
        });

        // Event listener para o bot√£o de pesquisa
        document.getElementById('searchSalesBtn').addEventListener('click', () => {
            const clientName = document.getElementById('searchClientName').value.trim();
            searchSalesByClient(clientName);
        });

        // Event listener para o seletor de meses
        document.getElementById('monthSelector').addEventListener('change', (event) => {
            renderMonthlyReceivables(event.target.value);
        });

        // --- Inicializa√ß√£o e Listeners do Firestore ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Espera a autentica√ß√£o an√¥nima ser conclu√≠da
            await signInAnonymously(auth).catch(error => {
                console.error("Erro na autentica√ß√£o an√¥nima durante o carregamento:", error);
                alert("N√£o foi poss√≠vel conectar ao banco de dados. Verifique sua conex√£o ou as configura√ß√µes do Firebase.");
            });

            // Verifica se as cole√ß√µes est√£o vazias e popula com dados iniciais
            const checkAndPopulateInitialData = async () => {
                const purchasesSnapshot = await getDocs(collection(db, 'purchases'));
                const salesSnapshot = await getDocs(collection(db, 'sales'));

                const initialPurchases = [
                    { date: '2025-04-02', device: 'iPhone 16 Pro 256GB', cost: 6449.00 },
                    { date: '2025-04-20', device: 'Poco X7 Pro 5G 512GB', cost: 2150.00 },
                    { date: '2025-05-30', device: 'Apple Watch SE 44mm', cost: 1700.00 },
                ];

                const initialSalesData = [
                    {
                        customer: 'Junior Pereira Agehab',
                        device: 'iPhone 16 Pro 256GB',
                        saleDate: '2025-04-02',
                        salePrice: 7800.00,
                        cost: 6449.00,
                        downPayment: 2500.00,
                        installments: [
                            { amount: 1100.00, paid: false },
                            { amount: 1100.00, paid: false },
                            { amount: 1100.00, paid: false },
                            { amount: 1100.00, paid: false },
                            { amount: 1100.00, paid: false },
                        ],
                    },
                    {
                        customer: 'Denilson',
                        device: 'Poco X7 Pro 5G 512GB',
                        saleDate: '2025-04-20',
                        salePrice: 2600.00,
                        cost: 2150.00,
                        downPayment: 1300.00,
                        installments: [
                            { amount: 325.00, paid: false },
                            { amount: 325.00, paid: false },
                            { amount: 325.00, paid: false },
                            { amount: 325.00, paid: false },
                        ],
                    },
                    {
                        customer: 'Junior Pereira Agehab',
                        device: 'Apple Watch SE 44mm',
                        saleDate: '2025-05-30',
                        salePrice: 2150.00,
                        cost: 1700.00,
                        downPayment: 450.00,
                        installments: [
                            { amount: 560.00, paid: false },
                            { amount: 560.00, paid: false },
                            { amount: 580.00, paid: false },
                        ],
                    },
                ];

                if (purchasesSnapshot.empty) {
                    console.log("Cole√ß√£o 'purchases' vazia. Populando com dados iniciais...");
                    for (const purchase of initialPurchases) {
                        await addPurchaseToFirestore(purchase);
                    }
                }

                if (salesSnapshot.empty) {
                    console.log("Cole√ß√£o 'sales' vazia. Populando com dados iniciais...");
                    for (const sale of initialSalesData) {
                        sale.installments.forEach((inst, index) => {
                            inst.dueDate = calculateInstallmentDueDate(sale.saleDate, index);
                        });
                        await addSaleToFirestore(sale);
                    }
                }

                if (purchasesSnapshot.empty || salesSnapshot.empty) {
                    console.log("Dados iniciais populados (se necess√°rio).");
                }
            };

            // Chama a fun√ß√£o para verificar e popular dados iniciais
            await checkAndPopulateInitialData();

            // Listener em tempo real para compras
            onSnapshot(collection(db, 'purchases'), (snapshot) => {
                purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPurchases();
                renderSummary();
            }, (error) => {
                console.error("Erro ao carregar compras: ", error);
                alert("Erro ao carregar dados de compras do banco de dados.");
            });

            // Listener em tempo real para vendas
            onSnapshot(collection(db, 'sales'), (snapshot) => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateMonthSelector(); // Repopula o seletor de meses sempre que as vendas mudam
                const selectedMonth = document.getElementById('monthSelector').value;
                renderSales(); // Renderiza a tabela de vendas completa
                renderMonthlyReceivables(selectedMonth); // Renderiza a tabela de recebimentos filtrada
                renderSummary();
                const clientName = document.getElementById('searchClientName').value.trim();
                if (clientName) {
                    searchSalesByClient(clientName);
                }
            }, (error) => {
                console.error("Erro ao carregar vendas: ", error);
                alert("Erro ao carregar dados de vendas do banco de dados.");
            });
        });
    </script>
</body>
</html>
